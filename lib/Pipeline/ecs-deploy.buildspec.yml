version: "0.2"
env:
  secrets-manager:
    DOCKERHUB_USERNAME: "<APP_NAME>/dockerhub/credentials:username"
    DOCKERHUB_PASS: "<APP_NAME>/dockerhub/credentials:password"
phases:
  pre_build:
    commands:
      - docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASS
      - $(aws ecr get-login --no-include-email --region $AWS_REGION)
  build:
    commands:
      - echo "building $ECR_REPO:$CODEBUILD_RESOLVED_SOURCE_VERSION"
      - docker build -t $ECR_REPO:$CODEBUILD_RESOLVED_SOURCE_VERSION -f Dockerfile .
  post_build:
    commands:
      - echo "pushing $ECR_REPO:$CODEBUILD_RESOLVED_SOURCE_VERSION"
      - docker push $ECR_REPO:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - printf "[{\"name\":\"ecs-deploy-container\",\"imageUri\":\"$ECR_REPO:$CODEBUILD_RESOLVED_SOURCE_VERSION\"}]" > imagedefinitions.json
artifacts:
  files:
    - "imagedefinitions.json"
